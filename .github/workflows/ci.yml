name: Continuous Integration

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  build_lint_test:
    name: Build, Lint, and Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Node.js (LTS)
      uses: actions/setup-node@v4
      with:
        node-version: '20' # Node.js 20 LTS (current for 2026 standards)
        cache: 'npm' # Cache npm dependencies

    - name: Install Dependencies
      run: npm ci # Ensures a clean and reproducible installation

    - name: Run Linter (ESLint)
      run: npm run lint # Assumes 'lint' script is defined in package.json for ESLint

    - name: Run Tests with Coverage
      run: npm test -- --coverage # Assumes 'test' script is defined, and supports coverage reporting (e.g., Jest/Vitest)

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }} # Ensure this secret is configured in your repository settings
        slug: chirag127/RapidStart-Express-NodeJS-WebApp-Template
        fail_ci_if_error: true
        verbose: true

  security_scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    needs: build_lint_test # Run security scan after successful build, lint, and tests

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Node.js (LTS)
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install Dependencies
      run: npm ci

    - name: Run npm audit for vulnerabilities
      run: npm audit --audit-level=high # Scans for high and critical vulnerabilities

  docker_image_build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: security_scan # Only build Docker image if security scan passes

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker Image
      run: |
        IMAGE_NAME=chirag127/rapidstart-express-nodejs-webapp-template
        TAG_VERSION=${{ github.sha }}
        docker build -t $IMAGE_NAME:$TAG_VERSION -t $IMAGE_NAME:latest .
        echo "Successfully built Docker image: $IMAGE_NAME:$TAG_VERSION"

    - name: Verify Docker Image
      run: docker images $IMAGE_NAME